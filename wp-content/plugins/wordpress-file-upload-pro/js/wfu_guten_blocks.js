var el=wp.element.createElement,Fragment=wp.element.Fragment,registerBlockType=wp.blocks.registerBlockType,PlainText=wp.editor.PlainText;function wfu_registerShortcodeBlock(e,t,r,o,n,a,s){registerBlockType(e,{title:t,icon:r,category:"widgets",attributes:{content:{type:"string",source:"html",default:n}},transforms:{from:[{type:"shortcode",tag:o,attributes:{content:{type:"string",shortcode:function(e){var t="";for(var r in e.named)e.named.hasOwnProperty(r)&&(t+=" "+r+'="'+e.named[r]+'"');return"[wordpress_file_upload"+t+"]"}}}},{type:"block",blocks:["core/html","core/paragraph","core/heading","core/preformatted","core/verse"],isMatch:function(e){return e.content&&e.content.substr(0,o.length+1)=="["+o&&"]"==e.content.substr(-1)},transform:function(t){return wp.blocks.createBlock(e,{content:t.content})}},{type:"block",blocks:["core/shortcode"],isMatch:function(e){return e.text&&e.text.substr(0,o.length+1)=="["+o&&"]"==e.text.substr(-1)},transform:function(t){return wp.blocks.createBlock(e,{content:t.text})}}],to:[{type:"block",blocks:["core/html"],transform:function(e){return wp.blocks.createBlock("core/html",{content:e.content})}},{type:"block",blocks:["core/paragraph"],transform:function(e){return wp.blocks.createBlock("core/paragraph",{content:e.content})}},{type:"block",blocks:["core/shortcode"],transform:function(e){return wp.blocks.createBlock("core/shortcode",{text:e.content})}}]},edit:function(e){var t="";function r(t){t.length>0&&" "!=t.substr(0,1)&&(t=" "+t),t="["+o+t+"]",e.setAttributes({content:t})}return e.attributes.content&&(t=e.attributes.content),t.substr(0,o.length+1)=="["+o&&(t=t.substr(o.length+1)),"]"==t.substr(-1)&&(t=t.substr(0,t.length-1)),t.length>0&&" "==t.substr(0,1)&&(t=t.substr(1)),WFUData.editors.push({id:e.clientId,window:null,updater:r}),el(Fragment,null,el("div",{className:s},el("label",null,a),"true"==AdminParams.wfu_can_edit?el("span",{className:"dashicons dashicons-edit "+s+"-btn"+(e.isSelected?" active":""),title:"Edit shortcode",onClick:new Function("wfu_invoke_shortcode_guteditor('"+e.clientId+"', '"+o+"');")}):null,el(PlainText,{key:"editable",className:s+"-text",onChange:r,value:t})))},save:function(e){return e.attributes.content}})}function wfu_GetHttpRequestObject(){var e=null;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}}if(null==e&&window.createRequest)try{xmlhttp=window.createRequest()}catch(e){}return e}function wfu_plugin_encode_string(e){var t,r=0,o="",n="";for(r=0;r<e.length;r++)(t=e.charCodeAt(r))>=2048?t=((16773120&t|917504)<<4)+((4032&t|8192)<<2)+(63&t|128):t>=128&&(t=((65472&t|12288)<<2)+(63&t|128)),1!=(n=t.toString(16)).length&&3!=n.length&&5!=n.length||(n="0"+n),o+=n;return o}function wfu_plugin_decode_string(e){for(var t,r,o=0,n="";o<e.length;)r=(t=parseInt(e.substr(o,2),16))<128?t:t<224?((31&t)<<6)+(63&parseInt(e.substr(o+=2,2),16)):((15&t)<<12)+((63&parseInt(e.substr(o+=2,2),16))<<6)+(63&parseInt(e.substr(o+=2,2),16)),n+=String.fromCharCode(r),o+=2;return n}function wfu_get_block_editor_data(e){for(var t=null,r=0;r<WFUData.editors.length;r++)if(WFUData.editors[r].id==e){t=WFUData.editors[r];break}return t}function wfu_set_block_editor(e,t){for(var r=0;r<WFUData.editors.length;r++)if(WFUData.editors[r].id==e){WFUData.editors[r].window=t;break}}function wfu_save_from_editor(e){var t=wfu_get_block_editor_data(e);if(t){var r=t.window;if(updater=t.updater,null!=r&&null!=updater){var o=r.ShortcodeString;r.close(),wfu_set_block_editor(e,null),updater(o)}}}function wfu_invoke_shortcode_guteditor(e,t){var r=wfu_GetHttpRequestObject();if(null!=r){var o=wp.data.select("core/editor").getBlock(e);if(o){var n=o.attributes.content;n.substr(0,t.length+1)=="["+t&&(n=n.substr(t.length+1)),"]"==n.substr(-1)&&(n=n.substr(0,n.length-1)),n=n.trim();var a=AdminParams.wfu_ajax_url;params=new Array(4),params[0]=new Array(2),params[0][0]="action",params[0][1]="wfu_ajax_action_gutedit_shortcode",params[1]=new Array(2),params[1][0]="shortcode",params[1][1]=wfu_plugin_encode_string(n),params[2]=new Array(2),params[2][0]="post_id",params[2][1]=wp.data.select("core/editor").getCurrentPostId(),params[3]=new Array(2),params[3][0]="shortcode_tag",params[3][1]=t;for(var s="",i=0;i<params.length;i++)s+=(i>0?"&":"")+params[i][0]+"="+encodeURI(params[i][1]);r.open("POST",a,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onreadystatechange=function(){if(4==r.readyState&&200==r.status){var t=r.responseText.indexOf("wfu_gutedit_shortcode:");-1==t&&(t=r.responseText.length),r.responseText.substr(0,t);var o=r.responseText.substr(t+22,r.responseText.length-t-22);t=o.indexOf(":");var n=o.substr(0,t);if(txt_value=o.substr(t+1,o.length-t-1),"success"==n){var a=wfu_get_block_editor_data(e);if(!a)return void alert("Error opening the shortcode editor. Please reload the page editor.");if(editor_window=a.window,null!=editor_window){if(!editor_window.wfu_changes_saved()&&!confirm("Another editor with unsaved changes might be open. If you press Ok the editor will re-open and any unsaved changes will be lost."))return;editor_window.wfu_force_save_changes(),editor_window.close(),wfu_set_block_editor(e,null)}editor_window=window.open(wfu_plugin_decode_string(txt_value),"_blank"),editor_window?(wfu_set_block_editor(e,editor_window),editor_window.fromGutenberg=!0,editor_window.blockId=e,editor_window.plugin_window=window):alert("Please enable popup windows.")}else"check_page_obsolete"==n&&alert(txt_value)}},r.send(s)}}}wfu_registerShortcodeBlock("wfu-guten-blocks/wfu-uploader","WFU Uploader Shortcode","upload","wordpress_file_upload",'[wordpress_file_upload uploadid="'+(Math.floor(9e3*Math.random())+1e3)+'"]',"WFU Uploader Shortcode","wfu-uploader-shortcode"),wfu_registerShortcodeBlock("wfu-guten-blocks/wfu-browser","WFU File Viewer Shortcode","images-alt2","wordpress_file_upload_browser",'[wordpress_file_upload_browser browserid="'+(Math.floor(9e3*Math.random())+1e3)+'"]',"WFU File Viewer Shortcode","wfu-browser-shortcode"),WFUData={editors:[]};
