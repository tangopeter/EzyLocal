<?php
/* ------------------------------------------------------------------------

   Copyright (c) 2020-2022 MAMP GmbH. All rights reserved.
   
   This file is part of the remote functionality of MAMP PRO. 

   ------------------------------------------------------------------------

   INSTRUCTIONS to use this script direcly on your web server:
    
   1. Create a new text file with the following content and adjust the 
      values to match your server's configuration:

<?php exit(0);?>
{
	"serverType":  "apache",
	"db_server": "127.0.0.1:3306",
	"db_name": "mysql",
	"db_username": "username",
	"db_password": "password"
}

   2. Save this configuration file using the following file name:

                   "config.json.php"

      Please make sure to keep the JSON files' extension ".php", which 
      will prevent its contents from being publicly available after it's 
      been uploaded to your web server.
	  
   3. Upload this script alongside with the previously created 
      configuration file "config.json.php" to your server, so both of 
      them are located within the same folder.

      You can use any subdirectory you like, as long as its contents are 
      reachable via a web browser.

   4. Now you should be able to call "check.php" directly 
      in your preferred web browser by calling an URL like this one 
      (by replacing the respective URL components accordingly, of course):

      http://yourdomain.com/path/to/check.php
   
      Please keep in mind that the file name of this script may differ.

   The script will then perform a series of tests and print out an overview 
   with many potentially relevant configuration issues that may arise, along 
   with some other informations which could prove useful when troubleshooting 
   the MAMP PRO remote features.

   -----------------------------------------------------------------------
*/

// avoid caching:
if(php_sapi_name() !== 'cli') {
	header("Expires: on, 01 Jan 1970 00:00:00 GMT");
	header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT");
	header("Cache-Control: no-store, no-cache, must-revalidate");
	header("Cache-Control: post-check = 0, pre-check=0", false);
	header("Pragma: no-cache");
}
?>
<?php define("DEFAULT_MYSQLD_VERSION","5.7");define("DEFAULT_MARIADB_VERSION"," 10.3");define("DEBUGLEVEL_ERROR",0);define("DEBUGLEVEL_VERBOSE",1);define("DEBUG_NOFILESTATS",isset($_GET["nofilestats"]));define("OPERATION_VERIFY",0);define("OPERATION_IMPORT",1);define("OPERATION_PUBLISH",2);define("OPERATION_MIGRATE",4);define("TEMP_TABLE_PREFIX","temp_mamppro_");enum(['HostTypeUnknown','HostTypeWordPress','HostTypeJoomla','HostTypeDrupal','HostTypeWebEdition','HostTypeTypo3','HostTypeConcrete5','HostTypeForkCMS','HostTypeMagento','HostTypePrestashop',]);clearstatcache(true,dirname(__FILE__).DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR);$requirementType='KEY_REQUIREMENT_TYPE';$requirementSubType='KEY_REQUIREMENT_SUBTYPE';$requirementMinPhpVersion='KEY_REQUIREMENT_MIN_PHP_VERSION';$requirementDiskSpaceNeeded='KEY_REQUIREMENT_SPACE_REQUIRED_FOR_UPLOAD';$requirementHasDatabase='KEY_REQUIREMENT_HAS_DATABASE';$requirementLocalServerType='KEY_REQUIREMENT_LOCAL_SERVER_TYPE';$requirementIsUpdate='KEY_REQUIREMENT_IS_UPDATE';$requirementWordPressSkipUploads='KEY_REQUIREMENT_WP_SKIP_UPLOADS';$requirementWordPressUploadsPath='KEY_REQUIREMENT_WP_UPLOADS_PATH';$requirementItemsToUpdateImportArray=json_decode('KEY_REQUIREMENT_ITEMS_TO_UPDATE_ARRAY',TRUE);$requirementIgnoredFilesArray=json_decode('KEY_REQUIREMENT_IGNORED_FILES_ARRAY',TRUE);$requirementPreferredArchiveMode="KEY_REQUIREMENT_PREFERRED_ARCHIVE_MODE";$requirementSiteRootPathDiffers='KEY_REQUIREMENT_SITEROOT_DIFFERS';$requirementMinMysqlVersion="KEY_REQUIREMENT_MYSQLD_VERSION";$requirementMinMariadbVersion="KEY_REQUIREMENT_MARRIADB_VERSION";$serverType='apache';$db_server='KEY_DB_SERVERNAME';$db_name='KEY_DB_NAME';$db_username='KEY_DB_USERNAME';$db_password='KEY_DB_PASSWORD';$sql_remote_script_dir_url='KEY_REMOTE_SCRIPT_DIR_URL';$remote_config_debuglevel='KEY_REMOTE_DEBUGLEVEL';$remote_config_permissions='KEY_REMOTE_PERMISSIONS';$remote_config_debug_keeptmp='KEY_REMOTE_DEBUG_KEEPTMP';$logfileEnabled=true;$logfile=dirname(__FILE__).DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR."errors.log.php";$unzip_source="..".DIRECTORY_SEPARATOR."backup";$unzip_destination="..".DIRECTORY_SEPARATOR."tempDocumentRoot";$move_origin_dir="..".DIRECTORY_SEPARATOR."tempDocumentRoot";$move_destination_dir="..".DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR.".";$zip_source="..".DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR.".";$zip_destination="..".DIRECTORY_SEPARATOR."backup".DIRECTORY_SEPARATOR;$zip_maxArchiveSize=100*1024*1024;$sql_dump_output_path=$unzip_source.DIRECTORY_SEPARATOR."databases.sql";if(empty($requirementWordPressUploadsPath)||substr($requirementWordPressUploadsPath,0,4)=="KEY_"){$wp_uploads_dir="wp-content".DIRECTORY_SEPARATOR."uploads";}else{$wp_uploads_dir=$requirementWordPressUploadsPath;}$version=trim(@file_get_contents(dirname(__FILE__).DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR."VERSION"));if(empty($version)){$version=trim(@file_get_contents(dirname(__FILE__).DIRECTORY_SEPARATOR."VERSION"));}$versionMAMP="KEY_MAMPPRO_VERSION";if(empty($versionMAMP)||substr($versionMAMP,0,4)=="KEY_"){$versionMAMP="";}if(isset($_SERVER["DOCUMENT_ROOT"])&&!empty($_SERVER["DOCUMENT_ROOT"])){$documentRootPath=$_SERVER["DOCUMENT_ROOT"];}if(empty($documentRootPath)){$documentRootPath=dirname(__FILE__).DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR.".";}$siteRootPathDiffers=false;if(!empty($documentRootPath)&&($requirementSiteRootPathDiffers===true||strtolower($requirementSiteRootPathDiffers)==="true"||strtolower($requirementSiteRootPathDiffers)==="yes"||intval($requirementSiteRootPathDiffers)==1)){$siteRootPathDiffers=true;}if(is_file(dirname(__FILE__).DIRECTORY_SEPARATOR."check.inc.php")){@require_once(dirname(__FILE__).DIRECTORY_SEPARATOR."check.inc.php");}$remoteHostType=getHostTypeAtPath($documentRootPath);$skipWordpressUploadsFolder=($remoteHostType==HostTypeWordPress&&$requirementWordPressSkipUploads=="YES");$preferredArchiveMode="none";if(!empty($requirementPreferredArchiveMode)&&substr($requirementPreferredArchiveMode,0,4)!="KEY_"){$preferredArchiveMode=strtolower($requirementPreferredArchiveMode);}if(empty($requirementMinMysqlVersion)||substr($requirementMinMysqlVersion,0,4)=="KEY_"){$requirementMinMysqlVersion=DEFAULT_MYSQLD_VERSION;}if(empty($requirementMinMariadbVersion)||substr($requirementMinMariadbVersion,0,4)=="KEY_"){$requirementMinMariadbVersion=DEFAULT_MARIADB_VERSION;}if(is_string($remote_config_debug_keeptmp)){$remote_config_debug_keeptmp=false;}if(is_string($remote_config_debuglevel)&&intval($remote_config_debuglevel,10)>1){$remote_config_debuglevel=DEBUGLEVEL_ERROR;}if($remote_config_debuglevel<DEBUGLEVEL_VERBOSE){error_reporting(E_ERROR|E_WARNING);}else{$remote_config_debuglevel=DEBUGLEVEL_VERBOSE;error_reporting(E_ALL);}ini_set("track_errors",1);ini_set("display_startup_errors",0);ini_set("display_errors",0);if($logfileEnabled===true){ini_set("log_errors",1);if(!is_file($logfile)){@touch($logfile);if(is_file($logfile)){@file_put_contents($logfile,"<?php exit(0);?>\n");ini_set("error_log",$logfile);debuglog("created error log for MAMP PRO");}else{}}else{ini_set("error_log",$logfile);}}else{if(is_file($logfile)){@unlink($logfile);}ini_set("log_errors",0);}clearstatcache();loadConfigFile(NULL,$serverType,$db_server,$db_name,$db_username,$db_password,$requirementMinPhpVersion);$dbAccountGiven=(!empty($db_server)&&!empty($db_name)&&!empty($db_username)&&substr($db_server,0,7)!='KEY_DB_'&&substr($db_name,0,7)!='KEY_DB_'&&substr($db_username,0,7)!='KEY_DB_'&&substr($db_password,0,7)!='KEY_DB_');function loadConfigFile($configFile=NULL,&$serverType,&$db_server,&$db_name,&$db_username,&$db_password,&$requirementMinPhpVersion){if(!is_string($configFile)||empty($configFile)){$configFile=dirname(__FILE__).DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR."config.json.php";if(!is_file($configFile)){$configFile=dirname(__FILE__).DIRECTORY_SEPARATOR."config.json.php";}}if(!is_readable($configFile)){$configFileInsecure=substr($configFile,0,-4);if(is_readable($configFileInsecure)){@rename($configFileInsecure,$configFile);}}if(is_readable($configFile)){$file=@file_get_contents($configFile);if($file){$phpExitStatement="<?php exit(0);?>".PHP_EOL;$phpExitStatementCheck=substr(trim($file),0,strlen($phpExitStatement));if($phpExitStatementCheck!=$phpExitStatement){$file=$phpExitStatement.$file;@file_put_contents($configFile,$file);}$json=json_decode(strip_tags($file));$serverType='apache';if(isset($json->serverType)&&!empty($json->serverType)){$serverType=$json->serverType;}if(isset($json->db_server)&&!empty($json->db_server)&&substr($json->db_server,0,7)!='KEY_DB_'){$db_server=$json->db_server;}if(isset($json->db_name)&&!empty($json->db_name)&&substr($json->db_name,0,7)!='KEY_DB_'){$db_name=$json->db_name;}if(isset($json->db_username)&&!empty($json->db_username)&&substr($json->db_username,0,7)!='KEY_DB_'){$db_username=$json->db_username;}if(isset($json->db_password)&&!empty($json->db_password)&&substr($json->db_password,0,7)!='KEY_DB_'){$db_password=$json->db_password;}if(isset($json->min_php_version)&&!empty($json->min_php_version)&&substr($json->min_php_version,0,8)!='KEY_PHP_'){$requirementMinPhpVersion=$json->min_php_version;}if(isset($json->min_mysql_version)&&!empty($json->min_mysql_version)&&substr($json->min_mysql_version,0,4)!='KEY_'){$requirementMinMysqlVersion=$json->min_mysql_version;}if(isset($json->min_mariadb_version)&&!empty($json->min_mariadb_version)&&substr($json->min_mariadb_version,0,4)!='KEY_'){$requirementMinMariadbVersion=$json->min_mariadb_version;}}}}function errorlog($message=""){debuglog($message,DEBUGLEVEL_ERROR);}function debuglog($message="",$level=DEBUGLEVEL_VERBOSE){global $remote_config_debuglevel;if(intval($remote_config_debuglevel)<intval($level)){return;}$oldtz=date_default_timezone_get();if($oldtz!="UTC"){date_default_timezone_set('UTC');}$output="[".date("Y-m-d h:i:s A")."] ";if($oldtz!=date_default_timezone_get()){date_default_timezone_set($oldtz);}if(!empty($message)){$trace=debug_backtrace(1);if(count($trace)>0){$filename=$trace[0]['file'];$line=$trace[0]['line'];$output="[".basename($filename)."] ";}$output.=$message;}error_log($output);}function endWithSuccess($parameters=array()){endScript(1,0,"",$parameters);}function failWithError($code=0,$message="",$parameters=array()){endScript(1,$code,$message,$parameters);}function endScript($progress=1,$code=0,$message="",$parameters=array()){$code=intval($code);$progress=intval($progress);$message=(string)$message;if(!is_array($parameters)){if(is_string($parameters)||is_numeric($parameters)){$parameters=array($parameters);}else{$parameters=array(@serialize($parameters));}}$returnValue=array("result"=>intval($code),"progress"=>intval($progress),"error"=>"",);if(is_array($parameters)&&count($parameters)>0){$returnValue["response"]=$parameters;}if($returnValue["progress"]==1){if($returnValue["result"]==0){debuglog("finished successfully.");}else{errorlog("finished with errors (no. ".$returnValue["result"]."): ".$returnValue["error"]);}}echo json_encode($returnValue);exit($code);}function currentOperation(){global $requirementType,$requirementSubType;if(strtolower($requirementSubType)=="verify"){return OPERATION_VERIFY;}if(strtolower($requirementSubType)=="migrate"){return OPERATION_MIGRATE;}if(strtolower($requirementType)=="upload"){return OPERATION_PUBLISH;}if(strtolower($requirementType)=="download"){return OPERATION_IMPORT;}return OPERATION_VERIFY;}$uuid=basename(realpath(dirname(__FILE__).DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR));if(strlen($remote_config_permissions)>0&&strlen($remote_config_permissions)<=4&&intval($remote_config_permissions)>0){define("CONFIG_PERMISSIONS",octdec($remote_config_permissions));}else{define("CONFIG_PERMISSIONS",false);}if(is_file($logfile)&&defined("CONFIG_PERMISSIONS")&&CONFIG_PERMISSIONS!==false){chmod($logfile,CONFIG_PERMISSIONS);}if(stripos($requirementType,"KEY_REQUIREMENT_TYPE")!=false||$requirementType=="check"){$requirementType="upload";$requirementSubType="verify";}if(stripos($requirementSubType,"KEY_REQUIREMENT_SUBTYPE")!=false){$requirementSubType="";}$isSmartUpdate=false;debuglog("smart update option is ".($isSmartUpdate?"ENABLED":"disabled"));$php_memory_limit=(int)ini_get('memory_limit');$orig_php_memory_limit=$php_memory_limit;$php_max_execution_time=intval(ini_get('max_execution_time'));$php_shell_exec_available=(is_callable('shell_exec')&&false===stripos(ini_get('disable_functions'),'shell_exec'));if($php_memory_limit>-1){ini_set('memory_limit',-1);$php_memory_limit=(int)ini_get('memory_limit');}if($php_memory_limit>0){ini_set('memory_limit','128M');$php_memory_limit=(int)ini_get('memory_limit');}$php_max_execution_time=intval(ini_get('max_execution_time'));if((int)$php_max_execution_time>0){$ret=set_time_limit(0);$php_max_execution_time=ini_get('max_execution_time');$php_max_execution_time=intval($php_max_execution_time);if(!$ret||$php_max_execution_time>0){debuglog("WARNING: unable to disable max_execution_time, trying to set it to 600");ini_set("max_execution_time",600);}}$php_max_execution_time=intval(ini_get('max_execution_time'));$php_timelimit_in_place=((int)$php_max_execution_time>0);$using_cli_tools=($php_shell_exec_available===true&&$php_timelimit_in_place===false);if((int)$remote_config_debuglevel>DEBUGLEVEL_ERROR){$summary_debugmessage="Received a remote operation request: ".$requirementType."".(isset($requirementSubType)&&!empty($requirementSubType)?"/".$requirementSubType:"").PHP_EOL."smart update: ".($isSmartUpdate==true?"YES":"NO").PHP_EOL."skip WordPress uploads folder: ".($skipWordpressUploadsFolder==true?"YES":"NO").PHP_EOL."memory limit: ".$php_memory_limit.PHP_EOL."max. execution time: ".$php_max_execution_time.PHP_EOL."timelimit in place: ".($php_timelimit_in_place==true?"YES":"NO").PHP_EOL."shell_exec available: ".($php_shell_exec_available==true?"YES":"NO").PHP_EOL."using CLI tools: ".($using_cli_tools==true?"YES":"NO").PHP_EOL."preferred archiving mode during import: ".$preferredArchiveMode.PHP_EOL."remote debug level: ".(intval($remote_config_debuglevel)>0?"debug":"error").PHP_EOL."remote scripts version: ".$version.PHP_EOL."uploaded by MAMP PRO version ".$versionMAMP.PHP_EOL;if(CONFIG_PERMISSIONS!==false){$summary_debugmessage.=PHP_EOL."permissions for created files: ".decoct(CONFIG_PERMISSIONS);}errorlog($summary_debugmessage);$requestParametrs=$_REQUEST;$debugurl=(isset($_SERVER['HTTPS'])&&$_SERVER['HTTPS']==='on'?"https":"http")."://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";$sensitiveNeedles=array("password","username","login","auth","bearer");$purgeURL=false;foreach($sensitiveNeedles as $needle){if(stripos(strtolower($debugurl),$needle)!==false){$purgeURL=true;break;}}if($purgeURL===true){$debugurl=(isset($_SERVER['HTTPS'])&&$_SERVER['HTTPS']==='on'?"https":"http")."://$_SERVER[HTTP_HOST]$_SERVER[PHP_SELF]";foreach($requestParametrs as $k=>$v){$purgeParameter=false;foreach($sensitiveNeedles as $needle){if(stripos(strtolower($k),$needle)!==false){$purgeParameter=true;break;}}if($purgeParameter===true){$requestParametrs[$k]="********";}}}debuglog("REQUEST URL: ".$debugurl);if(count($requestParametrs)>0)debuglog("REQUEST parameters: ".print_r($requestParametrs,1));}function has_prefix($haystack="",$needle="",$caseinsensitive=false){if(is_string($haystack)&&!empty($haystack)&&is_string($needle)&&!empty($needle)){if(strlen($haystack)>=strlen($needle)){if($caseinsensitive){$haystack=strtolower($haystack);$needle=strtolower($needle);}if(substr($haystack,0,strlen($needle))==$needle){return true;}}}return false;}function has_suffix($haystack="",$needle="",$caseinsensitive=false){if(is_string($haystack)&&!empty($haystack)&&is_string($needle)&&!empty($needle)){if(strlen($haystack)>=strlen($needle)){if($caseinsensitive){$haystack=strtolower($haystack);$needle=strtolower($needle);}if(substr($haystack,(0-strlen($needle)))==$needle){return true;}}}return false;}function is_alphanumeric($string=""){if(empty($string)){return true;}if(is_string($string)){if(is_callable("preg_match")){return preg_match('/^[a-zA-Z]+[a-zA-Z0-9._]+$/',$string);}if(ctype_alnum("preg_match")){return ctype_alnum($string);}}return false;}function enum(array $array,bool $asBitwise=false){if(!is_array($array)||count($array)<1){return false;}$n=0;foreach($array as $i){if(!define($i,$n==0?0:($asBitwise?1<<($n-1):$n))){return false;}++$n;}return true;}function remote_server_type(){if(isset($_SERVER["SERVER_SOFTWARE"])&&!empty($_SERVER["SERVER_SOFTWARE"])){$_sw=strtolower($_SERVER["SERVER_SOFTWARE"]);if(stripos($_sw,"apache")!==false){return "apache";}else if(stripos($_sw,"nginx")!==false){return "nginx";}else if(stripos($_sw,"litespeed")!==false){return "litespeed";}}else{ob_start();phpinfo();$info=strtolower(ob_get_contents());ob_end_clean();if(stripos($info,"--with-litespeed")!=false){return "litespeed";}else if(stripos($info,"nginx")!=false){return "nginx";}else if(stripos($info,"apache")!=false){return "apache";}}return "unknown";}function cli_tool_available($tool=""){global $using_cli_tools;if($using_cli_tools===true&&!empty($tool)){$ret=strtolower(trim(@shell_exec($tool."  2>&1")));if(stripos($ret,"command not found")===false&&stripos($ret,": not found")===false&&stripos($ret,"command '".trim($tool)."' not found")===false&&stripos($ret,"".trim($tool).": not found")===false){return true;}}return false;}function is_windows(){$uname=php_uname();return(stripos($uname,"windows")!==false||stripos($uname,"Windows")!==false||stripos($uname,"WINDOWS")!==false);}function chmod_recursively($path="",$permissions=0755,$clionly=false,$simulate=false){global $using_cli_tools;$disablecli=false;$clionly=false;$success=false;if($clionly===true&&(!$using_cli_tools||$disablecli===true)){debuglog("chmod_recursively: nothing to do with this configuration....");return;}if(empty($path)||$permissions===false||$permissions<1){debuglog("chmod_recursively: nothing to do....");return true;}debuglog("Trying to ".(is_dir($path)?"recursively":"")." chmod the ".(is_dir($path)?"folder":"file")." ".$path." to an octal value of ".decoct($permissions));if(!is_dir($path)){$success=chmod($path,$permissions);if($success!==true){errorlog("An error occured while trying to change a files's access permissions to ".(string)$permissions." at path: ".$path);}return false;}if($using_cli_tools&&$disablecli!==true){$success=true;debuglog("using cli tools to change the access permissions using chmod");$cmd="chmod -R 0".decoct($permissions)." ".$path." 2>&1";if($simulate){debuglog("simulate executing this shell command: ".$cmd);return true;}$ret=shell_exec($cmd);if(stripos(strtolower($ret),"cannot")!==FALSE||stripos(strtolower($ret),"error")!==FALSE||stripos(strtolower($ret),"invalid")!==FALSE){errorlog("FAILED changing the file permissions using the command line utility \"chmod\": ".$ret);}}else{try{$dir=new DirectoryIterator($path);foreach($dir as $item){if(basename($item->getPathname())=="."||basename($item->getPathname())==".."){continue;}$success=true;if($simulate){debuglog("simulate executing chmod PHP command with permissions ".decoct($permissions));}else{debuglog("execute chmod PHP command with permissions ".decoct($permissions)." on ".$item->getPathname());$success=@chmod($item->getPathname(),$permissions);}if($success!==true){errorlog("An error occured while trying to change a files's access permissions to ".(string)$permissions." at path: ".$path);}if($item->isDir()&&!$item->isDot()){$success=@chmod_recursively($item->getPathname(),$permissions);}}}catch(UnexpectedValueException $e){$success=false;$message=$e->getMessage();if(stripos($message,"permission denied")!==false){$success=true;}}}return $success;}function rmdir_recursively($path=""){global $disableCLI,$errorNumber,$errorMessage;if(empty($path)||file_exists($path)===false||is_writable($path)===false){return false;}if(is_file($path)||is_link($path)){return unlink($path);}if($disableCLI!==true&&cli_tool_available("rm")&&!is_windows()){debuglog("Trying to recursively remove the folder ".$path." using shell_exec (this approach avoids running into a timeout when dealing with large amounts of files and folders since it is usually a lot faster)");$cmd="rm -rf ".$path;$cmd.=" 2> /dev/null";$ret=@shell_exec($cmd);if(stripos(strtolower($ret),"cannot")!==FALSE||stripos(strtolower($ret),"error")!==FALSE||stripos(strtolower($ret),"invalid")!==FALSE){$errorNumber=1201;$errorMessage="FAILED recursively deleting a folder using the command line utility \"rm\": ".$ret;error_log("ERROR ".$errorNumber.": ".$errorMessage);return false;}$errorNumber=0;$errorMessage=NULL;}if($errorNumber==0){return true;}debuglog("Trying to recursively remove the folder ".$path." using PHP (this may run into a timeout when dealing with large amounts of files and folders)");$files=new RecursiveIteratorIterator(new RecursiveDirectoryIterator($path,RecursiveDirectoryIterator::SKIP_DOTS),RecursiveIteratorIterator::CHILD_FIRST);foreach($files as $fileinfo){if($fileinfo->isDir()){if(rmdir_recursively($fileinfo->getRealPath())===false){$errorNumber=1201;$errorMessage="FAILED recursively deleting a folder with PHP: ".$fileinfo;error_log("ERROR ".$errorNumber.": ".$errorMessage);return false;}}else{if(unlink($fileinfo->getRealPath())===false){$errorNumber=1201;$errorMessage="FAILED deleting a supposedly empty folder with PHP: ".$fileinfo;error_log("ERROR ".$errorNumber.": ".$errorMessage);return false;}}}return rmdir($path);}$importblacklist=dirname(__FILE__).DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR."importblacklist.tmp";function importblacklist(){global $importblacklist;if(!is_file($importblacklist)){@touch($importblacklist);}$json_str=@file_get_contents($importblacklist);if($json_str!==false&&strlen($json_str)>0){$array=json_decode($json_str,true,512,JSON_OBJECT_AS_ARRAY);if(is_array($array)){return $array;}}return array();}function importblacklist_append($path=""){global $importblacklist;if(!empty($path)){$array=importblacklist();if(!in_array($path,$array)){$array[]=$path;$json_str=json_encode($array);if($json_str!==false){@file_put_contents($importblacklist,$json_str);}}}}function is_blacklisted($path=""){if(!empty($path)){$array=importblacklist();if(in_array($path,$array)){return true;}}return false;} ?>
<?php function calledByMAMPPRO(){global $requirementType,$versionMAMP;if((isset($_REQUEST["mode"])&&$_REQUEST["mode"]=="html")||(isset($_REQUEST["output"])&&$_REQUEST["output"]=="html")||(isset($_REQUEST["format"])&&$_REQUEST["format"]=="html")){return false;}if((isset($_REQUEST["mode"])&&$_REQUEST["mode"]=="json")||(isset($_REQUEST["output"])&&$_REQUEST["output"]=="json")||(isset($_REQUEST["format"])&&$_REQUEST["format"]=="json")){return true;}if(!isset($versionMAMP)||empty($versionMAMP)||substr($versionMAMP,0,4)=="KEY_"){return false;}$userAgent=(isset($_SERVER['HTTP_USER_AGENT'])?$_SERVER['HTTP_USER_AGENT']:"");if(strlen($userAgent)>8&&substr($userAgent,0,8)=="MAMPPRO/"){return true;}if(isset($requirementType)&&$requirementType!="KEY_REQUIREMENT_TYPE"){return true;}return false;}function humanReadableSizeString($size,$metric=true){$sizeUnit=($size==1?"byte":"bytes");$sizeMultiplier=($metric==true?1000:1024);if($size>$sizeMultiplier){$size=$size/$sizeMultiplier;$sizeUnit=($metric==true?"KB":"KiB");if($size>$sizeMultiplier){$size=$size/$sizeMultiplier;$sizeUnit=($metric==true?"MB":"MiB");if($size>$sizeMultiplier){$size=$size/$sizeMultiplier;$sizeUnit=($metric==true?"GB":"GiB");}}$size=round($size,2);}return $size." ".$sizeUnit;}function getRemoteWordPressVersion(){$wpVersionFilePath=dirname(__FILE__)."/..".DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR."wp-includes".DIRECTORY_SEPARATOR."version.php";$remWordPressVersion="0";if(file_exists($wpVersionFilePath)){$input=file_get_contents($wpVersionFilePath,FILE_USE_INCLUDE_PATH);preg_match("/wp_version = '(.+?)';/",$input,$matchesOutput);$remWordPressVersion=$matchesOutput[1];}return $remWordPressVersion;}function getHostTypeNameAtPath($docRootPath=""){if(strlen($docRootPath)==0||substr($docRootPath,-1)!=DIRECTORY_SEPARATOR){$docRootPath.=DIRECTORY_SEPARATOR;}$hostType=getHostTypeAtPath($docRootPath);switch((int)$hostType){case HostTypeWordPress:return "WordPress";case HostTypeJoomla:return "Joomla";case HostTypeDrupal:return "Drupal";case HostTypeWebEdition:return "Webedition";case HostTypeTypo3:return "Typo3";case HostTypeConcrete5:return "Concrete5";case HostTypeForkCMS:return "ForkCMS";case HostTypeMagento:return "Magento";case HostTypePrestashop:return "Prestashop";case HostTypeUnknown:default:return "Unknown";}return "Unknown";}function getHostTypeAtPath($docRootPath=""){if(strlen($docRootPath)==0||substr($docRootPath,-1)!=DIRECTORY_SEPARATOR){$docRootPath.=DIRECTORY_SEPARATOR;}$remoteHostType=HostTypeUnknown;if(file_exists($docRootPath."wp-config.php")){$remoteHostType=HostTypeWordPress;}else if(file_exists($docRootPath."configuration.php")){$remoteHostType=HostTypeJoomla;}else if(file_exists($docRootPath."sites/default/settings.php")){$remoteHostType=HostTypeDrupal;}else if(file_exists($docRootPath."webEdition/we/include/conf/we_conf.inc.php")){$remoteHostType=HostTypeWebEdition;}else if(file_exists($docRootPath."typo3conf/LocalConfiguration.php")){$remoteHostType=HostTypeTypo3;}else if(file_exists($docRootPath."application/config/database.php")){$remoteHostType=HostTypeConcrete5;}else if(file_exists($docRootPath."app/config/parameters.yml")&&!file_exists($docRootPath."app/config/parameters.php")){$remoteHostType=HostTypeForkCMS;}else if(file_exists($docRootPath."app/etc/env.php")){$remoteHostType=HostTypeMagento;}else if(file_exists($docRootPath."app/config/parameters.yml")&&file_exists($docRootPath."app/config/parameters.php")){$remoteHostType=HostTypePrestashop;}return $remoteHostType;}function isWebsitePresent($docRootPath="",$checkForMAMPPlaceholder=false){if(strlen($docRootPath)==0||substr($docRootPath,-1)!=DIRECTORY_SEPARATOR){$docRootPath.=DIRECTORY_SEPARATOR;}if(!is_dir($docRootPath)){return false;}$hostType=getHostTypeAtPath($docRootPath);if($hostType!=HostTypeUnknown){return true;}$basenames=array("index","default");$extensions=array("htm","html","phtml","php");foreach($basenames as $basename){foreach($extensions as $extension){$path=$docRootPath.DIRECTORY_SEPARATOR.$basename.".".$extension;if(is_file($path)){if($checkForMAMPPlaceholder===true&&$basename=="index"&&$extension=="php"){$contents=@file_get_contents($path);if($contents){$needles=array("<title>MAMP PRO</title>"=>false,"placeholder page"=>false,"Platzhalter-Seite"=>false);foreach($needles as $key=>$value){if(stripos($contents,$key)!==false){$needles[$key]=true;}}$hasMissingNeedle=array_search(false,array_values($needles),true);if($hasMissingNeedle==true){return true;}}}else{return true;}}}}return false;}function isGzipAvailable(){$gzipAvailable=false;if(function_exists("gzcompress")||extension_loaded('zlib')||(function_exists('ob_gzhandler')&&ini_get('zlib.output_compression'))){$gzipAvailable=true;}else if(function_exists("apache_get_modules")&&count(array_intersect(['mod_deflate','mod_gzip'],apache_get_modules()))>0){$gzipAvailable=true;}return $gzipAvailable;}function clipVersionNumber($number="0",$maxParts=3,$padWithZeroes=true){$parts=explode(".",$number);if(count($parts)==$maxParts||$maxParts==0){return $number;}else if(count($parts)>$maxParts){$parts=array_slice($parts,0,$maxParts);return implode(".",$parts);}else if(count($parts)<$maxParts){if($padWithZeroes!==true){return $number;}$suffix="";$suffixSeparators=array("-","_"," ",":",";");$lastPart=$parts[count($parts)-1];foreach($suffixSeparators as $separator){$pos=stripos($lastPart,$separator);if($pos!==false){$suffix=substr($lastPart,$pos);$lastPart=substr($lastPart,0,($pos));$parts[count($parts)-1]=$lastPart;}}$diff=($maxParts-count($parts));for($i=0;$i<$diff;$i++){$parts[]="0";}$ret=implode(".",$parts);if(strlen($suffix)>0){$ret.=$suffix;}return $ret;}return $number;}function canRunRequirements($minPhpVersion){$versionParts=2;$remoteServerPhpVersion=clipVersionNumber(phpversion(),2);$minPhpVersion=clipVersionNumber($minPhpVersion,2);$errorNumber=(!empty($remoteServerPhpVersion)?0:101);if(!empty($minPhpVersion)){$errorNumber=102;if(function_exists('version_compare')){$errorNumber=103;if(version_compare($remoteServerPhpVersion,$minPhpVersion,'>=')){$errorNumber=0;}debuglog("PHP version requirement ".($errorNumber==0?"met":"NOT met")." (local: ".$minPhpVersion." remote: ".$remoteServerPhpVersion.")");}}$aReturnValue=array();$aReturnValue["result"]=$errorNumber;if($errorNumber!=0){$errorDescriptionLocalized=array();$calledByMAMPPRO=calledByMAMPPRO();if($calledByMAMPPRO==false){if(!empty($minPhpVersion)){$errorDescriptionLocalized["en"]="The remote server has to run PHP version ".$minPhpVersion." or later (the version used by your local host).";}else{$errorDescriptionLocalized["en"]="The remote server has to run the same or a later major PHP version than your local host (local: ".$minPhpVersion.")";}}else{$errorDescriptionLocalized["en"]="The remote server's PHP version is too old, it should be at least of the same major version as your local PHP version:\n\nLocal PHP version: ".$minPhpVersion."\nRemote PHP version: ".$remoteServerPhpVersion."\n";}$aReturnValue["errorDescription"]=$errorDescriptionLocalized;}return $aReturnValue;}function canRunServer($localServerType){$errorNumber=151;$knownServerTypes=array("apache","nginx","lightspeed",);if(!empty($localServerType)){$errorNumber=152;$remoteServer=$_SERVER["SERVER_SOFTWARE"];$remoteServerName=strtolower(explode("/",$remoteServer)[0]);if(!in_array($remoteServerName,$knownServerTypes)){$remoteServerName=remote_server_type();}if(!in_array($remoteServerName,$knownServerTypes)){$remoteServerName="unknown";}if(strtolower($remoteServerName)=="litespeed"){$remoteServerName="apache";}if(empty($localServerType)||substr($localServerType,0,4)=="KEY_"){$localServerType=$remoteServerName;}if(in_array($remoteServerName,$knownServerTypes)&&$localServerType==$remoteServerName){$errorNumber=0;}else{$errorNumber=152;}}$aReturnValue=array("result"=>$errorNumber,"serverType"=>$remoteServerName);if($errorNumber!=0){$errorDescriptionLocalized=array();$errorDescriptionLocalized["en"]="The server you are trying to transfer your site to has a different configuration than your local host. Please make sure you are using the same server type (Apache/Lightspeed or nginx). (Error: ".$errorNumber." / Remote web server: ".$remoteServer.")";$aReturnValue["errorDescription"]=$errorDescriptionLocalized;}return $aReturnValue;}function canRunSqlFile($db_server,$db_name,$db_username,$db_password){global $requirementMinMysqlVersion,$requirementMinMariadbVersion;$errorNumber=301;$errorDescription="Checking database to remote server";$mysqliVersion=1.0;$isMariaDB=false;if(!empty($db_server)&&!empty($db_name)&&!empty($db_username)&&!empty($db_password)){$errorNumber=302;if(function_exists('mysqli_connect')){$errorNumber=0;$mysqli=new mysqli($db_server,$db_username,$db_password);if(mysqli_connect_error()){$mysqliErrNo=mysqli_connect_errno();$errorDescription=$mysqli->connect_error;if($mysqliErrNo==2005){$errorNumber=310;}else if($mysqliErrNo==2008){$errorNumber=309;}else if($mysqliErrNo==2009){$errorNumber=308;}else if($mysqliErrNo==2003){$errorNumber=307;}else if($mysqliErrNo==1044){$errorNumber=306;}else if($mysqliErrNo==1045){$errorNumber=305;}else if($mysqliErrNo==1049){$errorNumber=304;}else{$errorNumber=303;}}if($errorNumber==0){$db_selected=mysqli_select_db($mysqli,$db_name);if(!$db_selected){$db_name=$mysqli->real_escape_string($db_name);$sql='CREATE DATABASE '.$db_name;if(!mysqli_query($mysqli,$sql)){$mysqliErrNo=mysqli_errno($mysqli);$errorDescription=$mysqli->error;if($mysqliErrNo==1064){$errorNumber=312;}else{$errorNumber=311;}}}}if($errorNumber==0){$infoMysqliVersion=$mysqli->server_info;$isMariaDB=stripos($infoMysqliVersion,"mariadb")!==false;$infoMysqliVersionInt=$mysqli->server_version;$infoMysqliVersionMain=(int)($infoMysqliVersionInt/10000);$infoMysqliVersionMinor=intval(($infoMysqliVersionInt-($infoMysqliVersionMain*10000))/100);$mysqliVersion=(string)($infoMysqliVersionMain.".".$infoMysqliVersionMinor);if(empty($mysqliVersion)){$mysqliVersion=1.0;}if($isMariaDB){if(version_compare($requirementMinMariadbVersion,$mysqliVersion,'!=')){$errorNumber=313;}}else{if(version_compare($requirementMinMysqlVersion,$mysqliVersion,'!=')){$errorNumber=313;}}}if($mysqli){$mysqli->close();}}}$aReturnValue=array();$aReturnValue["result"]=$errorNumber;$aReturnValue["remoteMySQLVersion"]=$mysqliVersion;$aReturnValue["remoteSQLServerType"]=($isMariaDB?"MariaDB":"MySQL");if($isMariaDB&&$errorNumber==313){$errorNumber=0;}if($errorNumber!=0){$enLocalErrorDescription="There was an error while trying to connect to your remote MySQL server database. Make sure the user credentials are correct and that the MySQLi Extension is installed on your remote server. (Error: ".$errorNumber." - ".$errorDescription.")";if($errorNumber==313){$enLocalErrorDescription="Your remote MySQL server version is different than your local MySQL server (MySQL 5.7). Different database versions could cause data loss while importing/exporting your database.";}$errorDescriptionLocalized=array();$errorDescriptionLocalized["en"]=$enLocalErrorDescription;$aReturnValue["errorDescription"]=$errorDescriptionLocalized;}return $aReturnValue;}function mysqlRunsInStrictMode($db_server,$db_name,$db_username,$db_password){$strictmode=false;$errorNumber=301;$errorDescription="No MySQL server available to be checked for running in strict mode";if(!empty($db_server)&&!empty($db_name)&&!empty($db_username)&&!empty($db_password)){if(function_exists('mysqli_connect')){$errorNumber=0;$mysqli=new mysqli($db_server,$db_username,$db_password);if(mysqli_connect_error()){$mysqliErrNo=mysqli_connect_errno();$errorDescription=$mysqli->connect_error;}else{$sql='SELECT @@sql_mode as sql_mode;';$result=$mysqli->query($sql);if(!$result){$mysqliErrNo=mysqli_errno($mysqli);$errorDescription=$mysqli->error;if($mysqliErrNo==1064){$errorNumber=312;}else{$errorNumber=311;}}else{$activeModes=array();$pertinentModes=array("STRICT_TRANS_TABLES","STRICT_ALL_TABLES","TRADITIONAL","innodb_strict_mode");while($myrow=$result->fetch_array(MYSQLI_ASSOC)){if(isset($myrow["sql_mode"])){$modes=explode(",",$myrow["sql_mode"]);}}$result->close();foreach($pertinentModes as $pertinentMode){if(in_array($pertinentMode,$modes)){$strictmode=true;break;}}}$mysqli->close();$errorNumber=314;}}}return $strictmode;}function getDatabaseSize($db_server,$db_name,$db_username,$db_password){$databaseSize=0;if(empty($db_server)||empty($db_name)||empty($db_username)||(substr($db_server,0,7)=='KEY_DB_'&&substr($db_name,0,7)=='KEY_DB_'&&substr($db_username,0,7)=='KEY_DB_')){return $databaseSize;}$mysqli=new mysqli($db_server,$db_username,$db_password);if(!mysqli_connect_error()&&mysqli_select_db($mysqli,$db_name)){$db_name=$mysqli->real_escape_string($db_name);$query="SELECT SUM(data_length+index_length) as sum FROM information_schema.TABLES WHERE table_schema = '".$db_name."'";$result=$mysqli->query($query);if($result!=NULL&&(mysqli_num_rows($result)>=1)){$row=$result->fetch_array(MYSQLI_ASSOC);if(!empty($row)){$databaseSize=intval($row["sum"]);}}}return $databaseSize;}function canWriteFiles($path=""){$aReturnValue=array();$errorNumber=401;$posixUserInfo="";if(empty($path)){if(isset($_SERVER["DOCUMENT_ROOT"])&&!empty($_SERVER["DOCUMENT_ROOT"])){$path=$_SERVER["DOCUMENT_ROOT"];}else{$path=dirname(__FILE__);}}clearstatcache(TRUE,$path);if(is_writable($path)){$errorNumber=0;}else{if(strtoupper(substr(PHP_OS,0,3))!=='WIN'){$posixUserInfo=" - user: ".posix_getpwuid(posix_getuid())." - euser: ".posix_getpwuid(posix_geteuid())." . ";}}$aReturnValue["result"]=$errorNumber;if($errorNumber!=0){$errorDescriptionLocalized=array();$errorDescriptionLocalized["en"]="Your remote server does not allow that user to create files. Make sure your remote path is writable and that user can create files. (Error: ".$errorNumber."".$posixUserInfo.")";$aReturnValue["errorDescription"]=$errorDescriptionLocalized;}return $aReturnValue;}function disk_free_space_wrapper($path="",&$error=NULL){if(!is_callable("disk_free_space")){$error="disk_free_space() has been disabled, probably for security reasons.";return 0;}$freespace=-1;clearstatcache(true,$path);$path=realpath($path);if(!empty($path)&&is_dir($path)){if(defined("PHP_FLOAT_MAX")&&@disk_free_space($path)<PHP_FLOAT_MAX){$freespace=@disk_free_space($path);}else{$freespace=@disk_free_space($path);}if($freespace===false){$_err=error_get_last();if($_err&&isset($_err["message"])&&!empty($_err["message"])){$error=$_err["message"];}else{$error="disk_free_space() failed to determine the available space.";}$freespace=0;}}if($freespace<0){$openBasedir=ini_get('open_basedir');if(!empty($openBasedir)){$error="disk_free_space() cannot determine the available space due to open_basedir restricions being in effect.";return 0;}}return $freespace;}function hasEnoughFreeDiskspaceForUpload($diskspaceNeeded,$directory){if(floatval($diskspaceNeeded)==0){return true;}$errorNumber=201;if(!empty($diskspaceNeeded)&&!empty($directory)){$errorNumber=202;$diskFreeSpace=disk_free_space_wrapper($directory);if(!empty($diskFreeSpace)){$errorNumber=($diskFreeSpace>=floatval($diskspaceNeeded))?0:203;}}if($errorNumber==0){return true;}$errorDescriptionLocalized=array();switch($errorNumber){case 202:{$errorDescriptionLocalized["en"]="Your remote server does now allow MAMP PRO to check if you have enough space on your remote server (Error: ".$errorNumber."). In order to complete the transfer, you need ".$sizeNeeded." bytes. You can get in touch with your host provider to check you have that enough disk space. Do you want to continue at your own risk?";}break;default:{$errorDescriptionLocalized["en"]="The remote server does not have enough disk space to complete the transfer. Please free up space and try again. (Error: ".$errorNumber.")";}}$aReturnValue=array("result"=>$errorNumber,"errorDescription"=>$errorDescriptionLocalized);return $aReturnValue;}function hasEnoughFreeDiskspaceForDownload($directory){$aReturnValue=array();$errorNumber=201;$sizeNeeded=floatval(3*getDirectorySize($directory));if(!empty($directory)){$errorNumber=202;$diskFreeSpace=disk_free_space_wrapper($directory);if(!empty($diskFreeSpace)){$errorNumber=($diskFreeSpace>=$sizeNeeded)?0:203;}}$aReturnValue["result"]=$errorNumber;if($errorNumber!=0){$errorDescriptionLocalized=array();switch($errorNumber){case 202:{$errorDescriptionLocalized["en"]="Your remote server does now allow MAMP PRO to check if you have enough space on your remote server (Error: ".$errorNumber."). In order to complete the transfer, you need ".$sizeNeeded." bytes. You can get in touch with your host provider to check you have that enough disk space. Do you want to continue at your own risk?";}break;default:{$errorDescriptionLocalized["en"]="The remote server does not have enough disk space to complete the transfer. Please free up space and try again. (Error: ".$errorNumber.")";}}$aReturnValue["errorDescription"]=$errorDescriptionLocalized;}return $aReturnValue;}function getDirectorySize($path='',&$errorCode=0,&$errorMessage=NULL){if(DEBUG_NOFILESTATS===true){return 0;}$bytestotal=0;clearstatcache(true,$path);$path=realpath($path);if($path===false||!file_exists($path)){$errorCode=853;$errorMessage="The directory [".$path."] does not exist or is not accessible to the current user. Please double-check its ownership and access permissions and try again.";debuglog($errorMessage);importblacklist_append($path);return 0;}if(!is_readable($path)){$errorCode=854;$errorMessage="The directory [".$path."] does exist, but it is not accessible to the current user. Please double-check its ownership and access permissions and try again.";debuglog($errorMessage);importblacklist_append($path);return 0;}if($path!==false&&$path!=''&&file_exists($path)){if(class_exists("RecursiveDirectoryIterator")){try{$pathIterator=new RecursiveDirectoryIterator($path,RecursiveDirectoryIterator::SKIP_DOTS);$objects=new RecursiveIteratorIterator($pathIterator,RecursiveIteratorIterator::SELF_FIRST);foreach($objects as $filename=>$object){try{$bytes=$object->getSize();if($bytes>0){$bytestotal+=$bytes;}}catch(UnexpectedValueException $e){$_message="The directory [".$path."] contains a directory we can not recurse into. Please double-check the ownership and access permissions for all its contens, look for any invalid symlinks/hardlinks/aliases and try again.";debuglog($_message);importblacklist_append($path);}}if($errorCode>0){errorlog("getDirectorySize ERROR [".$path."] ".$errorCode.": ".$errorMessage);}else{debuglog("getDirectorySize [".$path."] ".$bytestotal." bytes");}}catch(Exception $e){$errorMessage=array("en"=>"An error occurred while trying to determine a folder's content size, most likely due to some files and folders with insufficient access permissions. The folder sizes may be incorrect and the transferred data incomplete.","de"=>"Bei dem Versuch, die Größe des Ordnerinhalts zu ermitteln, ist ein Fehler aufgetreten, der höchstwahrscheinlich auf einige Dateien und Ordner mit unzureichenden Zugriffsrechten zurückzuführen ist. Die Ordnergrößen können falsch und die übertragenen Daten unvollständig sein.");debuglog($errorMessage);}}}return $bytestotal;}function getFileInfos($path){clearstatcache(true,$path);$path=realpath($path);$infos=array("filecount"=>0,"maxfilesize"=>0,"avgfilesize"=>0,"totalfilesize"=>0,);if($path!==false&&$path!=''&&file_exists($path)){try{$dirIterator=new RecursiveIteratorIterator(new RecursiveDirectoryIterator($path),RecursiveIteratorIterator::SELF_FIRST);foreach($dirIterator as $k=>$v){if($dirIterator->hasChildren()){foreach($dirIterator->getChildren()as $key=>$value){}}else{$infos["filecount"]++;$filesize=filesize($v);if($filesize>$infos["maxfilesize"]){$infos["maxfilesize"]=$filesize;}$infos["totalfilesize"]+=$filesize;}}}catch(Exception $e){errorlog("An error occurred while trying to determine a folder's content size, most likely due to some files and folders with insufficient access permissions. The folder sizes may be incorrect and the transferred data incomplete.");}}if($infos["filecount"]>0&&$infos["totalfilesize"]>0){$infos["avgfilesize"]=$infos["totalfilesize"]/$infos["filecount"];}return $infos;}function fileAcesssPermissions($path=""){global $serverType;if(empty($path)||!is_file($path)||!is_readable($path)){return false;}if(strtoupper(substr(PHP_OS,0,3))!=='WIN'){$fileownerinfo=posix_getpwuid(fileowner($path));if($fileownerinfo===false||empty($fileownerinfo)){$fileownerinfo=array("name"=>"","passwd"=>"","uid"=>0,"gid"=>0,"gecos"=>"","dir"=>"","shell"=>"");}$accesspermissions=fileperms_hr($path);if(isset($serverType)&&strtolower($serverType)=="apache"){$serverusername=getenv('APACHE_RUN_USER');}else if(is_callable('shell_exec')&&false===stripos(ini_get('disable_functions'),'shell_exec')){$serverusername=exec('whoami');}$serverownerinfo=posix_getpwnam($serverusername);if($serverownerinfo===false||empty($serverownerinfo)){if(!empty(posix_geteuid())){$serverownerinfo=posix_getpwuid(posix_geteuid());}else{$serverownerinfo=array("name"=>"","passwd"=>"","uid"=>0,"gid"=>0,"gecos"=>"","dir"=>"","shell"=>"");}}$info=array("owner"=>$fileownerinfo,"ownership"=>array("samegroup"=>boolval($fileownerinfo["uid"]==$serverownerinfo["uid"]),"sameuser"=>boolval($fileownerinfo["gid"]==$serverownerinfo["gid"]),"groupwritable"=>boolval(is_writable_by_group($path)),"globallywritable"=>boolval(is_writable_by_everyone($path)),),"path"=>$path,"permissions"=>$accesspermissions,"usercontext"=>$serverownerinfo,"whoami"=>$serverusername,);return $info;}return false;}function checkFileAcesssPermissions($path=""){if(empty($path)||!is_dir($path)||!is_readable($path)){return false;}if(strtoupper(substr(PHP_OS,0,3))!=='WIN'){$info=fileAcesssPermissions($path);if($info===false||!is_array($info)||empty($info)){return false;}return true;}return true;}function fileperms_hr($path){if(!is_readable($path)){return false;}$perms=fileperms($path);switch($perms&0xF000){case 0xC000:$info='s';break;case 0xA000:$info='l';break;case 0x8000:$info='r';break;case 0x6000:$info='b';break;case 0x4000:$info='d';break;case 0x2000:$info='c';break;case 0x1000:$info='p';break;default:$info='u';}$info.=(($perms&0x0100)?'r':'-');$info.=(($perms&0x0080)?'w':'-');$info.=(($perms&0x0040)?(($perms&0x0800)?'s':'x'):(($perms&0x0800)?'S':'-'));$info.=(($perms&0x0020)?'r':'-');$info.=(($perms&0x0010)?'w':'-');$info.=(($perms&0x0008)?(($perms&0x0400)?'s':'x'):(($perms&0x0400)?'S':'-'));$info.=(($perms&0x0004)?'r':'-');$info.=(($perms&0x0002)?'w':'-');$info.=(($perms&0x0001)?(($perms&0x0200)?'t':'x'):(($perms&0x0200)?'T':'-'));$octal=substr(sprintf("%o",$perms),-4);return $info." (".$octal.")";}function is_writable_by_group($path){if(!is_readable($path)){return false;}$perms=fileperms($path);if($perms&0x0010){return true;}return false;}function is_writable_by_everyone($path){if(!is_readable($path)){return false;}$perms=fileperms($path);if($perms&0x0002){return true;}return false;} ?>
<?php $version="3.2.0";?>
<?php $showErrors=false;if($showErrors===true){error_reporting(E_ALL);ini_set("track_errors",1);ini_set("display_errors",1);ini_set("display_startup_errors",1);ini_set("log_errors",0);}if(!isset($requirementType)){$requirementType="KEY_REQUIREMENT_TYPE";}if(!isset($requirementSubType)){$requirementSubType="KEY_REQUIREMENT_SUBTYPE";}$calledByMAMPPRO=calledByMAMPPRO();debuglog("called by MAMP PRO: ".($calledByMAMPPRO?"YES":"NO"));$documentRootPath="";if(isset($_SERVER["DOCUMENT_ROOT"])&&!empty($_SERVER["DOCUMENT_ROOT"])){$documentRootPath=$_SERVER["DOCUMENT_ROOT"];}else if($calledByMAMPPRO===true){$pathComponents=explode(DIRECTORY_SEPARATOR,dirname(__FILE__));if(count($pathComponents)>=2){$documentRootPath="..".DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR.".";}}$_ret=canWriteFiles($documentRootPath);$documentRootPathWritable=($_ret["result"]==0);$documentRootPathWritableError=$_ret["errorDescription"];$siteRootPath=$documentRootPath;$siteRootPathWritable=$documentRootPathWritable;$siteRootPathWritableError="";if($siteRootPathDiffers===true&&!empty($documentRootPath)){$pathComponents=explode(DIRECTORY_SEPARATOR,dirname(__FILE__));if(count($pathComponents)>0){$_path=$documentRootPath.DIRECTORY_SEPARATOR."..";$_ret=canWriteFiles($_path);if($_ret["result"]==0){$siteRootPath=$_path;$siteRootPathWritable=true;}else{$siteRootPathWritableError=$_ret["errorDescription"];$siteRootPathDiffers=false;}}}if($calledByMAMPPRO===true){if(defined("CONFIG_PERMISSIONS")&&CONFIG_PERMISSIONS!==false){chmod_recursively(dirname(__FILE__),CONFIG_PERMISSIONS);}if(isset($_REQUEST["cleanup"])&&intval($_REQUEST["cleanup"])==1){if(!empty($documentRootPath)){$contents=glob($documentRootPath.DIRECTORY_SEPARATOR.".mp-*",GLOB_ONLYDIR);clearstatcache(true,dirname(__FILE__).DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR);$currentDirectoryName=basename(realpath(dirname(__FILE__).DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR));foreach($contents as $entry){if(basename($entry)!=$currentDirectoryName){rmdir_recursively($entry);}}}}}else{$serverType='apache';$debug=false;$logfile=dirname(__FILE__).DIRECTORY_SEPARATOR.basename(__FILE__,".php").".log.php";if($debug!==true){if($showErrors!==true){error_reporting(E_ERROR);}ini_set("display_errors",0);ini_set("display_startup_errors",0);if(is_file($logfile)){@unlink($logfile);}ini_set("log_errors",0);}else{error_reporting(E_ALL);ini_set("track_errors",1);ini_set("display_errors",0);ini_set("display_startup_errors",0);ini_set("log_errors",1);if(!is_file($logfile)){@touch($logfile);if(is_file($logfile)){@file_put_contents($logfile,"<?php exit(0);?>".PHP_EOL);ini_set("error_log",$logfile);error_log("created error log for MAMP Pro");}else{ini_set("log_errors",0);}}else{ini_set("error_log",$logfile);}}}$dbAccountGiven=(!empty($db_server)&&!empty($db_name)&&!empty($db_username)&&substr($db_server,0,7)!='KEY_DB_'&&substr($db_name,0,7)!='KEY_DB_'&&substr($db_username,0,7)!='KEY_DB_'&&substr($db_password,0,7)!='KEY_DB_');foreach($_REQUEST as $key=>$val){$val=urldecode($val);$_REQUEST[$key]=$val;}if($calledByMAMPPRO===true){$tempArray=array();$warningsArray=array();$result=-1;$errorDescription=array();$errorDescription["en"]="Unknown Error. Please contact <support@mamp.info>.";$errorDescription["de"]="Unbekannter Fehler. Bitte wenden Sie sich an <support@mamp.info>.";$warningsDescription=array();$warningsDescription["en"]="There were some warnings which might cause problems further down the road.";$warningsDescription["de"]="Eines oder mehrere unkritische Probleme wurden erkannt.";$reqType=(isset($requirementType)?$requirementType:"KEY_REQUIREMENT_TYPE");$reqSubType=(isset($requirementSubType)?$requirementSubType:"KEY_REQUIREMENT_SUBTYPE");$minimumPhpVersion=(isset($requirementMinPhpVersion)?$requirementMinPhpVersion:"");$diskspaceNeededForUpload=$requirementDiskSpaceNeeded;$hasDatabase=$requirementHasDatabase;if($dbAccountGiven){$hasDatabase=$dbAccountGiven;}$localServerType=$requirementLocalServerType;$remoteHostType=0;$remoteWordPressVersion="";$remotePhpVersion=0;$remoteDocumentRootSize=0;$remoteDatabaseSize=0;$websiteIsPresent=false;$success=false;if(empty($documentRootPath)){$documentRootPath="..".DIRECTORY_SEPARATOR."..".DIRECTORY_SEPARATOR.".";}if(substr($reqType,0,4)=="KEY_"){$reqType="check";}if(($reqType=="upload"||$reqType=="publish"||$reqType=="check"||$reqSubType=="verify")&&!empty($minimumPhpVersion)&&!empty($localServerType)){$tempArray=canRunRequirements($minimumPhpVersion);$result=$tempArray["result"];$success=($result==0);if(!$success){$errorDescription=$tempArray["errorDescription"];array_push($warningsArray,$errorDescription);}if($success){$tempArray=canRunServer($localServerType);$result=$tempArray["result"];$success=($result==0);if(!$success){$errorDescription=$tempArray["errorDescription"];array_push($warningsArray,$errorDescription);}else{$remoteMySQLRunsInStrictMode=mysqlRunsInStrictMode($db_server,$db_name,$db_username,$db_password);}}if($success){if(!empty($hasDatabase)&&$hasDatabase=="YES"){$tempArray=canRunSqlFile($db_server,$db_name,$db_username,$db_password);$result=$tempArray["result"];$remoteMySQLVersion=$tempArray["remoteMySQLVersion"];if(isset($tempArray["remoteSQLServerType"])){$remoteSQLServerType=$tempArray["remoteSQLServerType"];$isMySQL=stripos($remoteSQLServerType,"mysql")!==false;$isMariaDB=stripos($remoteSQLServerType,"mariadb")!==false;if(!$isMySQL){if($isMariaDB){array_push($warningsArray,"It seems your remote server is running a MariaDB database server instead of MySQL. In most cases this won't make any difference since MariaDB stems from MySQL, but there may be incompatibilities which could break your website.");}else{$errorDescription="It seems your remote server is running an unsupported database server other than MySQL/MariaDB.";$errorCode=315;}}}$success=($result==0);if(!$success){$errorDescription=$tempArray["errorDescription"];if($result==313){array_push($warningsArray,$errorDescription);$result=0;$success=true;}}else{$remoteMySQLRunsInStrictMode=mysqlRunsInStrictMode($db_server,$db_name,$db_username,$db_password);}}}if($success){$tempArray=canWriteFiles();$result=$tempArray["result"];$success=($result==0);if(!$success){$errorDescription=$tempArray["errorDescription"];array_push($warningsArray,$errorDescription);}}if(!empty($warnings))error_log("There were warnings: ".print_r($warningsArray,1));if($success){$enoughSpaceResult=hasEnoughFreeDiskspaceForUpload($diskspaceNeededForUpload,$documentRootPath);if($enoughSpaceResult===true){$result=0;$success=true;}else{$result=$enoughSpaceResult["result"];$success=($result==0);if(!$success){$errorDescription=$enoughSpaceResult["errorDescription"];if($result==202){array_push($warningsArray,$errorDescription);$result=0;$success=true;}}}}}else if(($reqType=="download"||$reqType=="import"||$reqType=="check"||$reqType=="verify")&&!empty($localServerType)){$tempArray=canRunServer($localServerType);$result=$tempArray["result"];$success=($result==0);if(!$success){$errorDescription=$tempArray["errorDescription"];array_push($warningsArray,$errorDescription);}else{$remoteMySQLRunsInStrictMode=mysqlRunsInStrictMode($db_server,$db_name,$db_username,$db_password);}if($success){$success=function_exists("curl_version");if(!$success){$result=1;$lastError=error_get_last();if(!is_null($lastError)&&isset($lastError["message"])&&!empty($lastError["message"])){$errorDescription=print_r($lastError,1);}else{$errorDescription="It seems your remote server lacks cURL support. Please ensure that the cURL PHP library is installed and enabled.";}array_push($warningsArray,$errorDescription);}}if($success){$tempArray=canWriteFiles();$result=$tempArray["result"];$success=($result==0);if(!$success){$errorDescription=$tempArray["errorDescription"];array_push($warningsArray,$errorDescription);}}if(!empty($hasDatabase)&&$hasDatabase=="YES"){$tempArray=canRunSqlFile($db_server,$db_name,$db_username,$db_password);$result=$tempArray["result"];$remoteMySQLVersion=$tempArray["remoteMySQLVersion"];if(isset($tempArray["remoteSQLServerType"])){$remoteSQLServerType=$tempArray["remoteSQLServerType"];$isMySQL=stripos($remoteSQLServerType,"mysql")!==false;$isMariaDB=stripos($remoteSQLServerType,"mariadb")!==false;if(!$isMySQL){if($isMariaDB){array_push($warningsArray,"It seems yout remote server is running a MariaDB database server instead of MySQL. In most cases this won't make any difference since MariaDB stems from MySQL, but there may be incompatibilities which could break your website.");}else{array_push($warningsArray,"It seems your remote server is running a database server other than MySQL. While this may be working just fine, there may be incompatibilities which may cause the remote operation to fail, leaving a non-functional remote website.");}}}$success=($result==0);if(!$success){$errorDescription=$tempArray["errorDescription"];if($result==313){array_push($warningsArray,$errorDescription);$result=0;$success=true;}}else{$remoteMySQLRunsInStrictMode=mysqlRunsInStrictMode($db_server,$db_name,$db_username,$db_password);}}$tempArray=hasEnoughFreeDiskspaceForDownload($documentRootPath);$result=$tempArray["result"];$success=($result==0);if(!$success){$errorDescription=$tempArray["errorDescription"];if($result>0){array_push($warningsArray,$errorDescription);$result=0;$success=true;}}}header("Content-Type: application/json; charset=utf-8");$sizeErrorMessage=NULL;$sizeErrorCode=NULL;$remoteDocumentRootSize=getDirectorySize($documentRootPath,$sizeErrorCode,$sizeErrorMessage);if(!is_null($sizeErrorMessage)&&!empty($sizeErrorMessage)){if(is_array($sizeErrorMessage)){$warningsArray[]=$sizeErrorMessage;}else{$warningsArray[]["en"]=$sizeErrorMessage;}}$remoteDatabaseSize=getDatabaseSize($db_server,$db_name,$db_username,$db_password);$websiteIsPresent=isWebsitePresent($documentRootPath,false);$parts=explode('.',PHP_VERSION);$remotePhpVersion="";if(count($parts)>0){$remotePhpVersion.=$parts[0];if(count($parts)>1){$remotePhpVersion.=".".$parts[1];if(count($parts)>2){if(stripos($parts[2],"_")!==false){$remotePhpVersion.=".".substr($parts[2],0,stripos($parts[2],"_"));}else if(stripos($parts[2],"-")!==false){$remotePhpVersion.=".".substr($parts[2],0,stripos($parts[2],"-"));}else{$remotePhpVersion.=".".$parts[2];}}}}else{$remotePhpVersion=phpversion();}$remoteHostType=getHostTypeAtPath($documentRootPath);if($remoteHostType==HostTypeWordPress){debuglog("will look for wp version...");$remoteWordPressVersion=getRemoteWordPressVersion();}if($success=true){$result=0;}$returnValue=array();if(!is_numeric($result)){$result=-2;}$gzipAvailable=isGzipAvailable();$returnValue["runtime"]=array("memoryLimit"=>(int)$php_memory_limit,"timeLimitInPlace"=>(bool)$php_timelimit_in_place,"usingCliTools"=>(bool)$using_cli_tools,"gzipAvailable"=>(bool)$gzipAvailable,"phpVersion"=>(!empty($remotePhpVersion)?$remotePhpVersion:""));$serverType=canRunServer($serverType)["serverType"];$returnValue["webserver"]=array("serverType"=>$serverType,"httpHost"=>$_SERVER["HTTP_HOST"],);if((int)$remote_config_debuglevel>DEBUGLEVEL_ERROR){$debugParameters=array();if(count($debugParameters)>0){$returnValue["debug"]=$debugParameters;}}$pathInfo=array();$pathInfo["documentRoot"]=array("path"=>$documentRootPath,"writable"=>$documentRootPathWritable,"size"=>(!empty($remoteDocumentRootSize)?$remoteDocumentRootSize:0));$pathInfo["siteRoot"]=$pathInfo["documentRoot"];$pathInfo["siteRootUsed"]=$siteRootPathDiffers;if(!empty($siteRootPath)&&$documentRootPath!=$siteRootPath){$pathInfo["siteRoot"]=array("path"=>$siteRootPath,"writable"=>$siteRootPathWritable,"size"=>0 );}$returnValue["paths"]=$pathInfo;$returnValue["website"]=array("present"=>$websiteIsPresent,"hostType"=>(!empty($remoteHostType)?$remoteHostType:HostTypeUnknown));if($websiteIsPresent&&$remoteHostType==HostTypeWordPress&&!empty($remoteWordPressVersion)){$returnValue["website"]["WordPressVersion"]=$remoteWordPressVersion;}$returnValue["database"]=array("serverType"=>(!empty($remoteSQLServerType)?$remoteSQLServerType:""),"size"=>(!empty($remoteDatabaseSize)?$remoteDatabaseSize:0),"version"=>((isset($remoteMySQLVersion)&&!empty($remoteMySQLVersion))?$remoteMySQLVersion:""),"strictMode"=>(isset($remoteMySQLRunsInStrictMode)?$remoteMySQLRunsInStrictMode:false),);$returnValue["result"]=$result;if($result!=0){$returnValue["errorDescription"]=$errorDescription;}if($result==0||!empty($returnValue["errorDescription"])&&!stripos($returnValue["errorDescription"],"Unknown Error")){$returnValue["errorDescription"]=array();}if(empty($returnValue["errorDescription"])&&!empty($warningsArray)){$returnValue["warningsArray"]=$warningsDescription;}if(!empty($warningsArray)){$returnValue["warningsArray"]=$warningsArray;}echo json_encode($returnValue);exit(0);}if($calledByMAMPPRO!==true){if(empty($documentRootPath)){$documentRootPath=dirname(__FILE__);}$mtime=microtime(true);echo "<!DOCTYPE html>".PHP_EOL."<html><head>".PHP_EOL;echo "<title>MAMP Remote Server Status</title>".PHP_EOL;echo '<meta name="theme-color" content="#f6f8fa" media="(prefers-color-scheme: light)">'.PHP_EOL;echo '<meta name="theme-color" content="#161b22" media="(prefers-color-scheme: dark)">'.PHP_EOL;echo "<style type=\"text/css\">:root {--highlight-color:#888; --color-ok:#009900; --color-info:blue;}</style>".PHP_EOL;echo "<style type=\"text/css\">@media (prefers-color-scheme: dark) {:root {--highlight-color:#aaa; --color-ok:#009900; --color-info:#88bbff;} .ios-peek{background-color:#000; color: #eee;} body{background-color:#333; color: #eee;}} </style>".PHP_EOL;echo "<style type=\"text/css\">body, fieldset, legend, a, div, p {line-height:1.4em; font-family: -apple-system, system-ui, sans, sans-serif; font-size:0.95em; } legend icon {float:left; margin:-3px 10px 0px 0px} huge { font-size:2em; } hr {border:1px solid var(--highlight-color); border-width:1px 0px 0px 0px;} icon {display:inline-block; width: 20px; margin: 0px 8px 0px 3px; font-size:1.4em; vertical-align: text-bottom;} description {display:block; font-size:0.8em; margin-left:32px;} ul {margin:0px 0px;} legend {font-weight:bold; color:var(--highlight-color);} fieldset {width: 800px; margin:10px 0px; border:1px solid var(--highlight-color);} code {font-weight:bold; font-size:1.1em;} info {color:var(--color-info); font-weight:bold;} warning {color:orange; font-weight:bold;} error {color:red; font-weight:bold;} error span, warning span {margin-left:20px; float:right; color:black; font-weight:normal;} ok {color:var(--color-ok); font-weight:bold;} ul.checkmark {list-style: none;} ul.checkmark li.check:before {content: '✓';} li.uncheck:before {content: '✕';} hr.fieldset { margin-left:30px; } span.caption {font-weight:bold; color:var(--highlight-color);} fieldset div.multiline {display:inline-block; width:95%;}</style>".PHP_EOL;echo "<style type=\"text/css\">@media (prefers-color-scheme: dark) {blue {} }</style>".PHP_EOL;echo "<style type=\"text/css\" id=\"current-color-scheme\">.ColorScheme-Text { color:var(--highlight-color) }</style>".PHP_EOL;echo '<meta http-equiv="cache-control" content="max-age=0" />'.PHP_EOL;echo '<meta http-equiv="cache-control" content="no-cache" />'.PHP_EOL;echo '<meta http-equiv="expires" content="0" />'.PHP_EOL;echo '<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />'.PHP_EOL;echo '<meta http-equiv="pragma" content="no-cache" />'.PHP_EOL;echo "</head>".PHP_EOL."<body lang=\"en\">".PHP_EOL;echo "Collecting informations about the remote server's configuration to ascertain its compatibility with the MAMP PRO remote host features:<br/>".PHP_EOL;echo '<fieldset><legend><icon><div style="width:22px; height:22px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path style="fill:currentColor;fill-opacity:1;stroke:none" d="M 16 4 A 12 12 0 0 0 4 16 A 12 12 0 0 0 16 28 A 12 12 0 0 0 28 16 A 12 12 0 0 0 16 4 z M 16 5 A 11 11 0 0 1 27 16 A 11 11 0 0 1 16 27 A 11 11 0 0 1 5 16 A 11 11 0 0 1 16 5 z M 15 9 L 15 11 L 17 11 L 17 9 L 15 9 z M 15 13 L 15 23 L 17 23 L 17 13 L 15 13 z " id="path55" class="ColorScheme-Text" /></div></icon>General</legend>'.PHP_EOL;$canRunServerResult=canRunServer($serverType)["result"];$servernames=(isset($_SERVER["SERVER_SIGNATURE"])&&!empty(trim(strip_tags($_SERVER["SERVER_SIGNATURE"])))?trim(strip_tags($_SERVER["SERVER_SIGNATURE"])):(ucwords($serverType)));$remoteServerName=remote_server_type();if($servernames!=$remoteServerName&&$remoteServerName!="uknown"){$servernames.="/".ucfirst($remoteServerName);}echo "<icon>".($canRunServerResult==0?'<ok>&check;</ok>':'<error>&#10005;</error>')."</icon>Web server is supported by MAMP PRO ".($canRunServerResult==0?'<small>('.$servernames.")</small>":'')."<br/>".PHP_EOL;$hostTypeName=getHostTypeNameAtPath($documentRootPath);$hostType=getHostTypeAtPath($documentRootPath);echo "<icon></icon>Host type: ".$hostTypeName.($hostType==HostTypeUnknown?" (no extra found)":"")."<br/>".PHP_EOL;echo "</fieldset>".PHP_EOL;if(strtoupper(substr(PHP_OS,0,3))!=='WIN'){echo '<fieldset><legend><icon><div style="width:22px; height:22px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22"> <path style="fill:currentColor;fill-opacity:1;stroke:none" d="M 11 3 A 3.9999902 4.0000296 0 0 0 7 7 A 3.9999902 4.0000296 0 0 0 11 11 A 3.9999902 4.0000296 0 0 0 15 7 A 3.9999902 4.0000296 0 0 0 11 3 z M 11 4 A 3 3.0000296 0 0 1 14 7 A 3 3.0000296 0 0 1 11 10 A 3 3.0000296 0 0 1 8 7 A 3 3.0000296 0 0 1 11 4 z M 11 12 A 7.9999504 8.0000296 0 0 0 3.0722656 19 L 4.0800781 19 A 6.9999604 7.0000296 0 0 1 11 13 A 6.9999604 7.0000296 0 0 1 17.921875 19 L 18.929688 19 A 7.9999504 8.0000296 0 0 0 11 12 z " class="ColorScheme-Text" /></div></icon> User context</legend>'.PHP_EOL;$perminfo=fileAcesssPermissions(__FILE__);if($perminfo===false){echo "<icon><warning>&#9888;</warning></icon>An error occurred while trying to ascertain the ownership and access permissions of this script.<description>Maybe you're using an operating system which isn't fully supported or PHP's Process Control Extensions aren't available. We'll just assume for now that all requirements are being met, but keep in mind that this might have repercussions when actually performing any remote operations with MAMP PRO.</description>".PHP_EOL;}else{$fileownerinfo=$perminfo["owner"];$accesspermissions=$perminfo["permissions"];$serverownerinfo=$perminfo["usercontext"];$serverusername=$perminfo["whoami"];$ownership=$perminfo["ownership"];echo "<icon><info></info></icon>File owner: <code>".$fileownerinfo["name"].($fileownerinfo["uid"]==$fileownerinfo["gid"]?"/".$fileownerinfo["name"]:"")." (uid:".$fileownerinfo["uid"]." gid:".$fileownerinfo["gid"].")</code><br/>".PHP_EOL;echo "<icon></icon>File Access permissions: <code>".print_r($accesspermissions,1)."</code><br/>".PHP_EOL;if(!empty($serverownerinfo["name"])&&!empty($serverownerinfo["uid"])){echo "<icon></icon>Webserver user context: <code>".$serverownerinfo["name"].($serverownerinfo["uid"]==$serverownerinfo["gid"]?"/".$serverownerinfo["name"]:"")." (uid:".$serverownerinfo["uid"]." gid:".$serverownerinfo["gid"].")</code><br/>".PHP_EOL;}$message="";$iconhtml="<icon><ok>&check;</ok></icon>";if(!$ownership["sameuser"]){if($ownership["samegroup"]&&!$ownership["groupwritable"]){$iconhtml="<icon><warning>&#9888;</warning></icon>";$icontext="Different users, file not writable by the whole user group";$message="It seems <b>this file does not belong to the user running the webserver</b>, and the services' default file access permissions prevent them from modifying the files of each other. It is highly recommended that you update your server configuration accordingly, or else the MAMP PRO remote features may not work properly.".PHP_EOL;}else if(!$ownership["samegroup"]&&!$ownership["globallywritable"]){$iconhtml="<icon><warning>&#9888;</warning></icon>";$icontext="Different users and groups and file not writable by everyone";$message="It seems <b>this file does not belong to the user and group which is running the webserver</b>, and the services' default file access permissions prevent them from modifying the files of each other. It is highly recommended that you update your server configuration accordingly, or else the MAMP PRO remote features may not work properly.".PHP_EOL;}else{$icontext="All good.";$message="The file access permissions allow writing access to both the file owner and the user running the web server.".PHP_EOL;}}else{$icontext="All good.";$message="The file belongs to the same system user running this web server.".PHP_EOL;}echo $iconhtml.$icontext."<description>".$message."</description>";}echo "</fieldset>".PHP_EOL;}echo '<fieldset><legend><icon><div style="width:22px; height:22px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22"><path style="fill:currentColor;fill-opacity:1;stroke:none" d="M 3 3 L 3 4 L 3 19 L 4 19 L 19 19 L 19 18 L 19 5 L 12.007812 5 L 10.007812 3 L 10 3.0078125 L 10 3 L 4 3 L 3 3 z M 4 4 L 7 4 L 9.5859375 4 L 10.589844 5.0039062 L 6.5703125 9 L 6.5683594 9 L 4 9 L 4 4 z M 9.0078125 8 L 18 8 L 18 18 L 4 18 L 4 10 L 5.5625 10 L 7 10 L 7 9.9921875 L 7.0078125 10 L 9.0078125 8 z " class="ColorScheme-Text" /></div></icon> File system</legend>'.PHP_EOL;echo "<icon><info>&#9432;</info></icon>Document root path: <code>".$documentRootPath."</code><br/>".PHP_EOL;echo "<icon>".($documentRootPathWritable===true?'<ok>&check;</ok>':'<error>&#10005;</error>')."</icon>Document root is ".($documentRootPathWritable===true?"":"NOT ")."writable ".($documentRootPathWritable===true?'':'(Error: '.$documentRootPathWritableError.')')."<br/>".PHP_EOL;if($siteRootPathDiffers){echo "<icon><info>&#9432;</info></icon>Site root path: <code>".$siteRootPath."</code><br/>".PHP_EOL;echo "<icon>".($siteRootPathWritable===true?'<ok>&check;</ok>':'<error>&#10005;</error>')."</icon>Site root is ".($siteRootPathWritable===true?"":"NOT ")."writable ".($siteRootPathWritable===true?'':'(Error: '.$siteRootPathWritableError.')')."<br/>".PHP_EOL;}else{echo "<icon><info>&#9432;</info></icon>Site root path: <i>same as document root</i><br/>".PHP_EOL;}echo '<hr class="fieldset"/>'.PHP_EOL;$openBasedir=ini_get('open_basedir');if(!empty($openBasedir)){echo "<icon><warning>&#9888;</warning></icon><code>open_basedir</code> restrictions seem to be in effect.<br/>".PHP_EOL;echo "<icon></icon>This might prevent MAMP PRO's remote operations from working properly.<br/>".PHP_EOL;}else{echo "<icon><ok>&check;</ok></icon>open_basedir restrictions are not in effect.<br/>".PHP_EOL;}echo '<hr class="fieldset"/>'.PHP_EOL;echo '<icon><info></info></icon><span class="caption">Statistics</span><br/>'.PHP_EOL;$sizeErrorMessage=NULL;$sizeErrorCode=NULL;if(DEBUG_NOFILESTATS===true){$infos=array();$size=0;$sizeErrorMessage="File statistics omitted.";}else{$infos=getFileInfos($documentRootPath);$size=getDirectorySize($documentRootPath,$sizeErrorCode,$sizeErrorMessage);}if(!is_null($sizeErrorMessage)&&!empty($sizeErrorMessage)){if(DEBUG_NOFILESTATS===true){$iconStr="<icon><warning>&#9888;</warning></icon>";}else{$iconStr="<icon><error>&#10005;</error></icon>";}if(is_array($sizeErrorMessage)){echo $iconStr."<div class=\"multiline\">".$sizeErrorMessage["en"]."</div><br/>".PHP_EOL;}else{echo $iconStr."<div class=\"multiline\">".$sizeErrorMessage."</div><br/>".PHP_EOL;}}$error=NULL;$diskFreeSpace=disk_free_space_wrapper($documentRootPath,$error);$diskFreeSpaceDetermined=($diskFreeSpace>=0&&is_null($error));echo "<icon>".($diskFreeSpaceDetermined==false?"<warning>&#9888;</warning>":"")."</icon>Available space: ".($diskFreeSpace<0||!empty($error)?"<error>&#10005;</error> cannot be determined (".$error.")":humanReadableSizeString($diskFreeSpace))."<br/>".PHP_EOL;if(DEBUG_NOFILESTATS!==true){echo "<icon></icon>Document root size: ".humanReadableSizeString($size)."<br/>".PHP_EOL;echo "<icon></icon>Number of files: ".$infos["filecount"]."<br/>".PHP_EOL;echo "<icon></icon>Average file size: ".humanReadableSizeString($infos["avgfilesize"])."<br/>".PHP_EOL;echo "<icon></icon>Size of largest file: ".humanReadableSizeString($infos["maxfilesize"])."<br/>".PHP_EOL;}echo "</fieldset>".PHP_EOL;echo '<fieldset><legend><icon><div style="width:22px; height:22px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22"><path style="fill:currentColor;fill-opacity:1;stroke:none" d="M 11 3 A 8 3.0000005 0 0 0 3 6 L 3 16 A 8 3.0000005 0 0 0 11 19 A 8 3.0000005 0 0 0 19 16 L 19 6 A 8 3.0000005 0 0 0 11 3 z M 11 4 A 7 2 0 0 1 18 6 A 7 2 0 0 1 11 8 A 7 2 0 0 1 4 6 A 7 2 0 0 1 11 4 z M 18 7.4453125 L 18 11 A 7 2 0 0 1 11 13 A 7 2 0 0 1 4 11 L 4 7.4511719 A 8 3.0000005 0 0 0 11 9 A 8 3.0000005 0 0 0 18 7.4453125 z M 18 12.445312 L 18 16 A 7 2 0 0 1 11 18 A 7 2 0 0 1 4 16 L 4 12.451172 A 8 3.0000005 0 0 0 11 14 A 8 3.0000005 0 0 0 18 12.445312 z " class="ColorScheme-Text" /></svg></div></icon> Database Server</legend>'.PHP_EOL;if($dbAccountGiven===true){if(empty($db_password)){echo "WARNING: database password is empty!<br />".PHP_EOL;}$databaseSizeUnit="Byte";$databaseSize=getDatabaseSize($db_server,$db_name,$db_username,$db_password);$databaseSizeStr=humanReadableSizeString($databaseSize);$tempArrayCanRunSqlFile=canRunSqlFile($db_server,$db_name,$db_username,$db_password);if($tempArrayCanRunSqlFile["remoteSQLServerType"]=="MariaDB"){echo "<icon><warning>&#9888;</warning></icon>Warning: your remote server seems to be running MariaDB, so watch out for any incompatibilities<br/>".PHP_EOL;}$isMariaDB=(strtolower($tempArrayCanRunSqlFile["remoteSQLServerType"])=="mariadb");if($isMariaDB){echo "<icon>".((int)$tempArrayCanRunSqlFile["result"]>0?"<error>&#10005;</error>":"<ok>&check;</ok>")."</icon>Server ".((int)$tempArrayCanRunSqlFile["result"]>0?((int)$tempArrayCanRunSqlFile["result"]==313?" is running, but its version number ".$tempArrayCanRunSqlFile["remoteMySQLVersion"]." differs. MariaDB has to be of version ".$requirementMinMariadbVersion." or later.":"is not running or unreachable (ERROR: ".$tempArrayCanRunSqlFile["result"]." ".$tempArrayCanRunSqlFile["errorDescription"]["en"].")"):" is running")."".PHP_EOL;}else{echo "<icon>".((int)$tempArrayCanRunSqlFile["result"]>0?"<error>&#10005;</error>":"<ok>&check;</ok>")."</icon>Server ".((int)$tempArrayCanRunSqlFile["result"]>0?((int)$tempArrayCanRunSqlFile["result"]==313?" is running, but its version number ".$tempArrayCanRunSqlFile["remoteMySQLVersion"]." differs. It has to be of version ".$requirementMinMysqlVersion." (matching MAMP PRO) or later":"is not running or unreachable (ERROR: ".$tempArrayCanRunSqlFile["result"]." ".$tempArrayCanRunSqlFile["errorDescription"]["en"].")"):" is running")."".PHP_EOL;}if($tempArrayCanRunSqlFile["result"]==0){echo "<br/>".PHP_EOL;$serverTypeName=(!empty($tempArrayCanRunSqlFile["remoteSQLServerType"])?$tempArrayCanRunSqlFile["remoteSQLServerType"]." version":"Version");echo "<icon></icon>Server: ".$serverTypeName." ".(!empty($tempArrayCanRunSqlFile["remoteMySQLVersion"])?$tempArrayCanRunSqlFile["remoteMySQLVersion"]:"n/a")."<br/>".PHP_EOL;echo "<icon></icon>Database size: ".($databaseSize>0?$databaseSizeStr:"<error>&#10005; ERROR</error>: can't be determined, maybe the database information_schema is missing or can't be accessed with the given user credentials").PHP_EOL;if(isset($tempArrayCanRunSqlFile["errorDescription"]["en"])&&!empty($tempArrayCanRunSqlFile["errorDescription"]["en"])){echo "<br/><br />WARNING: ".$tempArrayCanRunSqlFile["errorDescription"]["en"].PHP_EOL;}}if($tempArrayCanRunSqlFile["result"]==0||$tempArrayCanRunSqlFile["result"]==313){$remoteMySQLRunsInStrictMode=mysqlRunsInStrictMode($db_server,$db_name,$db_username,$db_password);if($remoteMySQLRunsInStrictMode==true){echo "<br/><icon><info>&#9432;</info></icon>The mysql server runs in <a href=\"https://dev.mysql.com/doc/refman/8.0/en/sql-mode.html#sql-mode-strict\" target=\"blank\" hreflang=\"en\" rel=\"external\" type=\"text/html\">strict mode</a>.<description>This Server SQL Mode controls how MySQL handles invalid or missing values in data-change statements such as INSERT or UPDATE. This may cause an sql import to fail due to incompatibilities if the server which created the dump did not take that into account. Values can be invalid for several reasons. For example, it might have the wrong data type for the column, or it might be out of range.</description>".PHP_EOL;}}}else{echo "<icon><info>&#9432;</info></icon>No database server credentials specified, so these checks will be omitted.".PHP_EOL;}echo "</fieldset>".PHP_EOL;echo '<fieldset><legend><icon><div style="width:22px; height:22px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path style="fill:currentColor;fill-opacity:1;stroke:none" d="M 16 4 A 12 12 0 0 0 4 16 A 12 12 0 0 0 16 28 A 12 12 0 0 0 28 16 A 12 12 0 0 0 16 4 z M 16 5 A 11 11 0 0 1 27 16 A 11 11 0 0 1 16 27 A 11 11 0 0 1 5 16 A 11 11 0 0 1 16 5 z M 15 9 L 15 11 L 17 11 L 17 9 L 15 9 z M 15 13 L 15 23 L 17 23 L 17 13 L 15 13 z " id="path55" class="ColorScheme-Text" /></div></icon>MAMP PRO Remote Operations</legend>'.PHP_EOL;$supportsCurl=(function_exists('curl_init')!==false);echo "<icon>".($supportsCurl==true?'<ok>&check;</ok></icon>':'<error>&#10005;</error></icon>')."The PHP/curl extension is ".($supportsCurl==true?"":"NOT ")."available on this server (required for publishing hosts)<br/>".PHP_EOL;$reqType=(isset($requirementType)?$requirementType:"");$reqSubType=(isset($requirementSubType)?$requirementSubType:"");if($calledByMAMPPRO&&$reqType=="upload"){echo "<icon>".($hasEnoughFreeDiskspaceForDownloadResult==true?'<ok>&check;</ok></icon>Sufficient':'<error>&#10005;</error></icon>Insufficient')." free space for publishing this host<br/>".PHP_EOL;}$hasEnoughFreeDiskspaceForDownloadResult=($diskFreeSpaceDetermined==true&&$diskFreeSpace>=(2*$size));echo "<icon>".($hasEnoughFreeDiskspaceForDownloadResult==true?'<ok>&check;</ok></icon>Sufficient':''.($diskFreeSpaceDetermined==false?"<warning>&#9888;</warning></icon>Unknown amount of ":"<error>&#10005;</error></icon>Insufficient"))." free space for uploading this host<br/>".PHP_EOL;echo "</fieldset>".PHP_EOL;echo '<fieldset><legend><icon>‹<small>/</small>›</icon> Scripting</legend>'.PHP_EOL;$minimumPhpVersion=(isset($requirementMinPhpVersion)?$requirementMinPhpVersion:"");$tempArray=canRunRequirements($minimumPhpVersion);$result=$tempArray["result"];$success=($result==0);if(!$success){$errorDescription=$tempArray["errorDescription"];echo "<icon><error>&#10005;</error></icon>PHP Version: <code>".phpversion()."</code><br/>".PHP_EOL;echo "<icon></icon>".$errorDescription["en"]."<hr class=\"fieldset\" />".PHP_EOL;}else{echo "<icon><info>&#9432;</info></icon>PHP Version: <code>".phpversion()."</code><br/>".PHP_EOL;}echo "<icon></icon><code>max_execution_time: ".ini_get("max_execution_time")."</code><br/>".PHP_EOL;$oldMemLimit=intval(ini_get("memory_limit"));echo "<icon></icon><code>memory_limit: ".$oldMemLimit."</code><br/>".PHP_EOL;ini_set("memory_limit",($oldMemLimit==256?"128M":"256M"));@set_time_limit(0);$executionTime=ini_get("max_execution_time");echo "<icon>".($executionTime==0?"<ok>&check;</ok>":"<error>&#10005;</error>")."</icon><code>set_time_limit(0)</code> allowed<br/>".PHP_EOL;if($oldMemLimit>0&&$executionTime!=$oldMemLimit){}else{echo "<icon>".(ini_get("memory_limit")!=$oldMemLimit?"<ok>&check;</ok>":"<error>&#10005;</error>")."</icon><code>memory_limit</code> can be changed programmatically<br/>".PHP_EOL;}$gzipAvailable=isGzipAvailable();$zipArchiveAvailable=class_exists("ZipArchive");if($zipArchiveAvailable){$zip=new ZipArchive;if(is_null($zip)){$zipArchiveAvailable=false;}}echo "<icon>".($gzipAvailable===true?"<ok>&check;</ok>":"<warning>&#9888;</warning>")."</icon><code>gzip</code> compression ".($gzipAvailable===true?"":"un")."available<br/>".PHP_EOL;echo "<icon>".($zipArchiveAvailable===true?"<ok>&check;</ok>":"<warning>&#9888;</warning>")."</icon><code>ZipArchive</code> PHP extension ".($zipArchiveAvailable===true?"":"un")."available<br/>".PHP_EOL;$shellExecPossible=(is_callable('shell_exec')&&false===stripos(ini_get('disable_functions'),'shell_exec'));echo "<icon>".($shellExecPossible===true?"<ok>&check;</ok>":"<error>&#10005;</error>")."</icon><code>shell_exec()</code> allowed (for CLI commands)<br/>".PHP_EOL;if($shellExecPossible===true){$commandsToCheck=array("zip","unzip","mysql","mysqldump");echo '<ul class="checkmark">'.PHP_EOL;foreach($commandsToCheck as $command){$available=cli_tool_available($command);echo "<li class=\"".($available?"check":"uncheck")."\"> <code>".$command."</code> is ".($available?"":"not ")."available</li>".PHP_EOL;}echo "</ul>".PHP_EOL;}echo "</fieldset>".PHP_EOL;$runtime=microtime(true)-$mtime;$versionStr="";if(!empty($version)){$versionStr=" [Script Version ".$version."";if(!empty($versionMAMP)){$versionStr.="MAMP PRO ".$versionMAMP;}$versionStr.="]";}echo "Finished running tests after ".round($runtime,3)." sec. at ".date("Y-m-d H:i:s").$versionStr.".<br/>\n";echo "</body>".PHP_EOL;echo "</html>".PHP_EOL;} ?>
